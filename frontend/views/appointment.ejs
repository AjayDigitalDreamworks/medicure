<%- include('./partials/sidebar.ejs') %>
<link rel="stylesheet" href="/css/app.css">

<div class="content-area p-4">
  <style>
    .appointment-row {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .appointment-row .form-control-sm {
      width: 120px;
    }
  </style>

  <div class="dashboard-content">
    <!-- Appointments Overview -->
    <div class="appointments-overview">
      <div class="overview-header">
        <h2>Appointments Overview</h2>
      </div>

      <div class="appointments-stats-grid">
        <div class="appointment-stat-card">
          <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
          <div class="stat-info">
            <h3>Pending Appointments</h3>
            <div class="stat-number"><%- pendingAppointments %></div>
            <div class="stat-subtitle">Awaiting confirmation</div>
          </div>
        </div>

        <div class="appointment-stat-card">
          <div class="stat-icon confirmed"><i class="fas fa-check-circle"></i></div>
          <div class="stat-info">
            <h3>Confirmed Today</h3>
            <div class="stat-number"><%- confirmAppointments %></div>
            <div class="stat-subtitle">Ready for consultation</div>
          </div>
        </div>

        <div class="appointment-stat-card">
          <div class="stat-icon completed"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-info">
            <h3>Completed Today</h3>
            <div class="stat-number"><%- completedAppointments %></div>
            <div class="stat-subtitle">Consultations finished</div>
          </div>
        </div>

        <div class="appointment-stat-card">
          <div class="stat-icon cancelled"><i class="fas fa-times-circle"></i></div>
          <div class="stat-info">
            <h3>Cancelled Today</h3>
            <div class="stat-number"><%- cancelAppointments %></div>
            <div class="stat-subtitle">No-shows & cancellations</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and List -->
    <div class="appointments-filters">
      <div class="search-filter">
        <i class="fas fa-search"></i>
        <input type="text" id="searchAppointments" placeholder="Search by patient name or ID..." value="<%= searchTerm %>">
      </div>
      <div class="filter-controls">
        <select id="statusFilter">
          <option value="">All Status</option>
          <option value="pending" <%= selectedStatus === 'pending' ? 'selected' : '' %>>Pending</option>
          <option value="confirmed" <%= selectedStatus === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
          <option value="completed" <%= selectedStatus === 'completed' ? 'selected' : '' %>>Completed</option>
          <option value="cancelled" <%= selectedStatus === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
        </select>

        <select id="departmentFilter">
          <option value="">All Departments</option>
          <option value="general medicine" <%= selectedDepartment === 'general medicine' ? 'selected' : '' %>>General Medicine</option>
          <option value="cardiology" <%= selectedDepartment === 'cardiology' ? 'selected' : '' %>>Cardiology</option>
          <option value="orthopedics" <%= selectedDepartment === 'orthopedics' ? 'selected' : '' %>>Orthopedics</option>
          <option value="pediatrics" <%= selectedDepartment === 'pediatrics' ? 'selected' : '' %>>Pediatrics</option>
          <option value="dermatology" <%= selectedDepartment === 'dermatology' ? 'selected' : '' %>>Dermatology</option>
          <option value="emergency" <%= selectedDepartment === 'emergency' ? 'selected' : '' %>>Emergency</option>
        </select>

        <select id="dateFilter">
          <option value="">All Dates</option>
          <option value="today" <%= selectedDate === 'today' ? 'selected' : '' %>>Today</option>
          <option value="tomorrow" <%= selectedDate === 'tomorrow' ? 'selected' : '' %>>Tomorrow</option>
          <option value="week" <%= selectedDate === 'week' ? 'selected' : '' %>>This Week</option>
          <option value="month" <%= selectedDate === 'month' ? 'selected' : '' %>>This Month</option>
        </select>

        <button id="applyFiltersBtn" class="btn btn-primary">Apply</button>
        <button class="reset-filters-btn btn btn-secondary">Reset</button>
      </div>
    </div>

    <!-- Appointments Table + Add Button -->
    <div class="appointments-list">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>All Appointments</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAppointmentModal">
          <i class="fas fa-plus"></i> Add Appointment
        </button>
      </div>

      <div class="appointments-table">
        <div class="table-header d-flex">
          <div class="header-cell flex-fill">Patient Details</div>
          <div class="header-cell flex-fill">Appointment Info</div>
          <div class="header-cell flex-fill">Doctor</div>
          <div class="header-cell flex-fill">Status</div>
          <div class="header-cell flex-fill">Notify Delay</div>
          <div class="header-cell flex-fill">Actions</div>
        </div>

        <% if (appointments.length > 0) { %>
          <% appointments.forEach(appointment => { %>
            <% const status = String(appointment.status || '').toLowerCase(); %>
            <div class="appointment-row d-flex align-items-center"
                 data-patient="<%= (appointment.patient?.name || 'unknown').toLowerCase() %>"
                 data-status="<%= status %>"
                 data-department="<%= (appointment.department || '').toLowerCase() %>"
                 data-date="<%= appointment.formattedDate %>">

              <!-- Patient -->
              <div class="patient-details flex-fill">
                <div class="patient-name"><%= appointment.patient?.name || 'unknown' %></div>
              </div>

              <!-- Appointment Info -->
              <div class="appointment-info flex-fill">
                <div class="appointment-date"><%= appointment.date %></div>
                <div class="appointment-time"><%= appointment.time %></div>
              </div>

              <!-- Doctor -->
              <div class="doctor-info flex-fill">
                <div class="doctor-name"><%= appointment.doctor %></div>
                <div class="doctor-department"><%= appointment.department %></div>
              </div>

              <!-- Status -->
              <div class="status-cell flex-fill">
                <% if (status === 'pending') { %>
                  <span class="badge bg-warning text-dark">Pending</span>
                <% } else if (status === 'confirmed') { %>
                  <span class="badge bg-success">Confirmed</span>
                <% } else if (status === 'delayed') { %>
                  <span class="badge bg-warning">Delayed</span>
                <% } else if (status === 'rescheduled') { %>
                  <span class="badge bg-warning">Rescheduled</span>
                <% } else if (status === 'completed') { %>
                  <span class="badge bg-info text-dark">Completed</span>
                <% } else if (status === 'cancelled') { %>
                  <span class="badge bg-danger">Cancelled</span>
                <% } %>
              </div>

              <!-- Delay -->
              <div class="delay-cell flex-fill">
                <% if (['pending', 'rescheduled', 'delayed'].includes(status)) { %>
                  <form action="/admin/appointment/<%= appointment._id %>/delay" method="POST" class="d-flex align-items-center gap-2">
                    <input type="number" name="delayMinutes" placeholder="Delay in minutes" required class="form-control form-control-sm" />
                    <button class="btn btn-warning btn-sm">Notify Delay</button>
                  </form>
                <% } else { %>
                  <em>No actions</em>
                <% } %>
              </div>

              <!-- Actions -->
              <div class="appointment-actions flex-fill d-flex gap-2">
                <% if (['pending', 'rescheduled'].includes(status)) { %>
                  <form action="/admin/appointments/<%= appointment._id %>/confirm" method="POST">
                    <button type="submit" class="btn btn-sm btn-success">✔</button>
                  </form>
                  <form action="/admin/appointments/<%= appointment._id %>/reject" method="POST">
                    <button type="submit" class="btn btn-sm btn-danger">✖</button>
                  </form>
                <% } else if (['confirmed', 'delayed'].includes(status)) { %>
                  <form action="/admin/appointments/<%= appointment._id %>/complete" method="POST">
                    <button type="submit" class="btn btn-sm btn-primary">Complete</button>
                  </form>
                  <form action="/admin/appointments/<%= appointment._id %>/reject" method="POST">
                    <button type="submit" class="btn btn-sm btn-danger">✖</button>
                  </form>
                <% } else { %>
                  <em>No actions</em>
                <% } %>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-muted p-3">No appointments available.</p>
        <% } %>
      </div>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-container mt-3 d-flex justify-content-end">
      <nav aria-label="Appointments pagination">
        <ul class="pagination mb-0">
          <% if (currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= searchTerm %>&status=<%= selectedStatus %>&department=<%= selectedDepartment %>&date=<%= selectedDate %>">Previous</a>
            </li>
          <% } else { %>
            <li class="page-item disabled"><a class="page-link">Previous</a></li>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&search=<%= searchTerm %>&status=<%= selectedStatus %>&department=<%= selectedDepartment %>&date=<%= selectedDate %>"><%= i %></a>
            </li>
          <% } %>

          <% if (currentPage < totalPages) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= searchTerm %>&status=<%= selectedStatus %>&department=<%= selectedDepartment %>&date=<%= selectedDate %>">Next</a>
            </li>
          <% } else { %>
            <li class="page-item disabled"><a class="page-link">Next</a></li>
          <% } %>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Add Appointment Modal -->
<div class="modal fade" id="addAppointmentModal" tabindex="-1" aria-labelledby="addAppointmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="/admin/appointments/add" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addAppointmentModalLabel">Add Appointment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <label class="form-label">Patient Name</label>
            <input type="text" name="patientName" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Patient ID</label>
            <input type="text" name="patientId" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Time</label>
            <input type="time" name="time" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Doctor</label>
            <input type="text" name="doctor" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Department</label>
            <select name="department" class="form-control" required>
              <option value="general medicine">General Medicine</option>
              <option value="cardiology">Cardiology</option>
              <option value="orthopedics">Orthopedics</option>
              <option value="pediatrics">Pediatrics</option>
              <option value="dermatology">Dermatology</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Status</label>
            <select name="status" class="form-control" required>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Appointment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById('applyFiltersBtn').addEventListener('click', function() {
    const search = document.getElementById('searchAppointments').value;
    const status = document.getElementById('statusFilter').value;
    const department = document.getElementById('departmentFilter').value;
    const date = document.getElementById('dateFilter').value;

    const url = new URL(window.location.href);
    url.searchParams.set('search', search);
    url.searchParams.set('status', status);
    url.searchParams.set('department', department);
    url.searchParams.set('date', date);

    window.location.href = url.toString();
  });

  document.querySelector('.reset-filters-btn').addEventListener('click', function() {
    const url = new URL(window.location.href);
    url.searchParams.delete('search');
    url.searchParams.delete('status');
    url.searchParams.delete('department');
    url.searchParams.delete('date');
    window.location.href = url.toString();
  });
</script>

<%- include('./partials/footer.ejs') %>
